function [data] = crg_wgs84_crg2html(data, file, opts)
%CRG_WGS84_CRG2HTML Generate HTML file to visualize OpenCRG data in a map.
%   CRG_WGS84_CRG2HTML(DATA, FILE, OPTS) generates a HTML file to display
%   OpenCRG data as a track in a web-based map using OpenLayers.
%
%   Inputs:
%   DATA    struct array as defined in CRG_INTRO
%   FILE    html file to write
%   OPTS    stuct for method options (optional, no default)
%   .mpol   maximum number of map polyline points (default: 100)
%   .minc   minimum increment of map polyline points (default: 1.0)
%   .title  title on web page (default: 'OpenCRG road overview')
%   .filenm file name on web page (default: DATA.filenm if available)
%
%   Outputs:
%   DATA    struct array as defined in CRG_INTRO
%
%   Examples:
%   data = crg_wgs84_wgs2html(data, 'crg-demo.html');
%   web('crg-demo.html', '-browser')
%   Generates crg-demo.html in current directory and shows it.
%
%   See also CRG_INTRO.

% *****************************************************************
% ASAM OpenCRG Matlab API
%
% OpenCRG version:           1.2.0
%
% package:               lib
% file name:             crg_wgs84_crg2html.m
% author:                ASAM e.V.
%
%
% C by ASAM e.V., 2020
% Any use is limited to the scope described in the license terms.
% The license terms can be viewed at www.asam.net/license
%
% More Information on ASAM OpenCRG can be found here:
% https://www.asam.net/standards/detail/opencrg/
%
% *****************************************************************

%% check if already successfully checked

if ~isfield(data, 'ok')
    data = crg_check(data);
    if ~isfield(data, 'ok')
        error('CRG:checkError', 'check of DATA was not completely successful')
    end
end

%% handle optional arguments

mpol = 100;         % maximum number of polyline points
minc = 1.0;         % minimum polyline point u increment
title  = 'ASAM OpenCRG - Road overview';
filenm = '&lt;unknown CRG file name&gt;';

if nargin < 3
    opts = struct;
end
if isfield(opts, 'mpol')
    mpol = opts.mpol;
end
if isfield(opts, 'minc')
    minc = opts.minc;
end
if isfield(opts, 'title')
    title = opts.title;
end
if isfield(opts, 'filenm')
    filenm = opts.filenm;
else
    if isfield(data, 'filenm')
        filenm = data.filenm;
    end
end

%% check if WGS-84 end is available

if ~isfield(data.head, 'eend')
    error('CRG:wgs84Error', 'WGS84 coordinates along road are missing')
end

%% generate WGS-84 coordinates

npol = min(mpol, ceil((data.head.uend-data.head.ubeg)/minc));

puv = zeros(npol, 2);
puv(:, 1) = linspace(data.head.ubeg, data.head.uend, npol);

[pxy data] = crg_eval_uv2xy(data, puv);
[wgs data] = crg_wgs84_xy2wgs(data, pxy);

[pz data] = crg_eval_uv2z(data, puv([1 end],:));

%% generate map opts struct

m_opts = struct;

m_opts.title  = title;

m_opts.header = [ ...
    '<div id="asam-crg-header">' ...
    '<h1>' title '</h1>' ...
    '<h3>' filenm '</h3>' ...
    '</div>' ...
    ];

    m_opts.height = 'calc(100% - 10rem)';

m_opts.footer = [ ...
    '<div id="asam-crg-footer">' ...
    '<address>generated by '  mfilename ' at ' datestr(now, 31) '<br>' ...
    'visit <a href="https://www.asam.net/standards/detail/opencrg/">https://www.asam.net/standards/detail/opencrg/</a> to get latest news' ...
    '</address>' ...
    '<div id="asam-logo-container"><a href="https://www.asam.net/standards/detail/opencrg/" target="_blank"></a></div>' ...
    '</div>' ...
];

m_opts.css = [
   'address { margin: 0.5rem; font-size: 1rem;}' ...
   'a:link, a:visited {color: #006ea5}' ...
   '#asam-crg-header { background: linear-gradient(135deg, #006ea5 33%, #4ab9ab 100%); color: white; padding: 0.5rem 0.5rem; height: 6.2rem; box-sizing: border-box; }' ...
   '#asam-crg-footer{ display: flex; justify-content: space-between; height: 3.5rem; }' ...
   '#asam-logo-container { box-sizing: border-box; height: 100%; width: 30%; padding: 0.3rem; background: url(https://www.asam.net/typo3conf/ext/asam_cms/Resources/Public/Images/asam-logo.svg) center no-repeat content-box; }' ...
   '#asam-logo-container a { display: inline-block; width: 100%; height: 100%; }' ...
];

m_opts.beg_pu = [ ...
    '<h4>Start of CRG road:</h4>' ...
    '<table style=\"text-align:right\"><tbody>' ...
    '  <tr><td>U =</td><td>' num2str(data.head.ubeg, '%.3f') '</td></tr>' ...
    '  <tr><td>V =</td><td>' num2str(             0, '%.3f') '</td></tr>' ...
    '  <tr><td>X =</td><td>' num2str(data.head.xbeg, '%.3f') '</td><td></td><td>lon =</td><td>' num2str(data.head.ebeg, '%.6f') '</td></tr>' ...
    '  <tr><td>Y =</td><td>' num2str(data.head.ybeg, '%.3f') '</td><td></td><td>lat =</td><td>' num2str(data.head.nbeg, '%.6f') '</td></tr>' ...
    ];
if isfield(data.head, 'abeg')
    alti = pz(1) - data.head.zbeg + data.head.abeg;
    m_opts.beg_pu = [m_opts.beg_pu ...
        '  <tr><td>Z =</td><td>' num2str(         pz(1), '%.3f') '</td><td></td><td>alt =</td><td>' num2str(          alti, '%.6f') '</td></tr>' ...
        ];
else
    m_opts.beg_pu = [m_opts.beg_pu '<tr><td>Z =</td><td>' num2str(pz(1), '%.3f') '</td></tr>'];
end
if data.head.xoff ~= 0
    m_opts.beg_pu = [m_opts.beg_pu '<tr><td>Xoff =</td><td>' num2str(data.head.xoff, '%+.3f') '</td></tr>'];
end
if data.head.yoff ~= 0
    m_opts.beg_pu = [m_opts.beg_pu '<tr><td>Yoff =</td><td>' num2str(data.head.yoff, '%+.3f') '</td></tr>'];
end
if data.head.zoff ~= 0
    m_opts.beg_pu = [m_opts.beg_pu '<tr><td>Zoff =</td><td>' num2str(data.head.zoff, '%+.3f') '</td></tr>'];
end
m_opts.beg_pu = [m_opts.beg_pu '</tbody></table>'];

m_opts.course_pu  = [ ...
'<h4>Course of CRG road:</h4>' ...
'<table style=\"text-align:right\"><tbody>' ...
'  <tr><td>Vmin =</td><td>' num2str(data.head.vmin, '%.3f') '</td><td>Uinc =</td><td>' num2str(data.head.uinc, '%.3f') '</td></tr>' ...
'  <tr><td>Vmax =</td><td>' num2str(data.head.vmax, '%.3f') '</td><td>Vinc =</td><td>' num2str(data.head.vinc, '%.3f') '</td></tr>' ...
'   </tbody></table>'];

m_opts.end_pu  = [ ...
    '<h4>End of CRG road:</h4>' ...
    '<table style=\"text-align:right\"><tbody>' ...
    '  <tr><td>U =</td><td>' num2str(data.head.uend, '%.3f') '</td></tr>' ...
    '  <tr><td>V =</td><td>' num2str(             0, '%.3f') '</td></tr>' ...
    '  <tr><td>X =</td><td>' num2str(data.head.xend, '%.3f') '</td><td></td><td>lon =</td><td>' num2str(data.head.eend, '%.6f') '</td></tr>' ...
    '  <tr><td>Y =</td><td>' num2str(data.head.yend, '%.3f') '</td><td></td><td>lat =</td><td>' num2str(data.head.nend, '%.6f') '</td></tr>' ...
    ];
if isfield(data.head, 'abeg')
    alti = pz(2) - data.head.zend + data.head.aend;
    m_opts.end_pu  = [m_opts.end_pu  ...
        '  <tr><td>Z =</td><td>' num2str(         pz(2), '%.3f') '</td><td></td><td>alt =</td><td>' num2str(          alti, '%.6f') '</td></tr>' ...
        ];
else
    m_opts.end_pu  = [m_opts.end_pu  '<tr><td>Z =</td><td>' num2str(pz(2), '%.3f') '</td></tr>'];
end
if data.head.xoff ~= 0 && data.head.poff == 0
    m_opts.end_pu  = [m_opts.end_pu  '<tr><td>Xoff =</td><td>' num2str(data.head.xoff, '%+.3f') '</td></tr>'];
end
if data.head.yoff ~= 0 && data.head.poff == 0
    m_opts.end_pu  = [m_opts.end_pu  '<tr><td>Yoff =</td><td>' num2str(data.head.yoff, '%+.3f') '</td></tr>'];
end
if data.head.zoff ~= 0
    m_opts.end_pu  = [m_opts.end_pu  '<tr><td>Zoff =</td><td>' num2str(data.head.zoff, '%+.3f') '</td></tr>'];
end
m_opts.end_pu  = [m_opts.end_pu  '</tbody></table>'];


%% call map routine

map_wgs2html(wgs/180*pi, file, m_opts);

end
